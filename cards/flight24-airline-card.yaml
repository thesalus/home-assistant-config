type: custom:html-template-card
title: ""
ignore_line_breaks: true
entities:
  - sensor.flightradar24_current_in_area
  - sensor.flightradar24_last_5_flights
  - sensor.flightradar24_most_tracked
content: >
  {# Adapted from https://github.com/potseeslc/flight24-airline-card #}
  {# --- User Configuration --- #}
  {# Flight selection is limited to flights above this threshold (ft) #}
  {% set altitude_min_ft = 2500 %}
  {# Given there's no clean way to get the distance, I'm making it a user config #}
  {% set distance_unit = 'km' %}

  {# --- Get flight lists --- #}
  {% set local  = state_attr('sensor.flightradar24_current_in_area', 'flights') or [] %}
  {% set last_5 = state_attr('sensor.flightradar24_last_5_flights', 'flights') or [] %}
  {% set most   = state_attr('sensor.flightradar24_most_tracked', 'flights') or [] %}

  {# --- Pick closest local flight above threshold --- #}
  {% set ns = namespace(best=None, best_dist=999999999) %}
  {% for fl in local %}
    {% if fl is mapping
          and 'latitude' in fl and 'longitude' in fl
          and 'altitude' in fl and (fl['altitude'] or 0) > altitude_min_ft %}
      {% set d = distance('zone.home', fl['latitude'], fl['longitude']) %}
      {% if d is number and d < ns.best_dist %}
        {% set ns.best = fl %}
        {% set ns.best_dist = d %}
      {% endif %}
    {% endif %}
  {% endfor %}
  {% if not ns.best %}
    {% for fl in last_5 %}
      {% if fl is mapping
            and 'latitude' in fl and 'longitude' in fl
            and 'altitude' in fl and (fl['altitude'] or 0) > altitude_min_ft %}
        {% set d = distance('zone.home', fl['latitude'], fl['longitude']) %}
        {% if d is number and d < ns.best_dist %}
          {% set ns.best = fl %}
          {% set ns.best_dist = d %}
        {% endif %}
      {% endif %}
    {% endfor %}
  {% endif %}

  {% if ns.best %}
    {% set mode = 'local' %}
    {% set f = ns.best %}
    {% set dist = (ns.best_dist) | round(1) %}
  {% else %}
    {% set mode = 'most' %}
    {% set f = most[0] if most|length > 0 else None %}
  {% endif %}

  <div style="
    width:100%;
    display:flex;
    align-items:center;
    justify-content:center;
    font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
  ">

  {% if not f %}
    <div style="font-size:16px;opacity:0.85;">
      No flights available ✈️
    </div>
  {% else %}

    {# --- Extract values safely --- #}
    {% set fn       = (f.get('flight_number','')       | string) %}
    {% set cs       = (f.get('callsign','')            | string) %}
    {% set airline  = (f.get('airline_short','Unknown')| string) %}
    {% set airline_l= airline | lower %}
    {% set origin   = f.get('airport_origin_city','Unknown') %}
    {% set dest     = f.get('airport_destination_city','Unknown') %}
    {% set alt      = f.get('altitude', 0) or 0 %}
    {% set gs       = f.get('ground_speed', 0) or 0 %}
    {% set aircraft = f.get('aircraft_type')
                       or f.get('aircraft_model')
                       or f.get('aircraft_code')
                       or 'Unknown' %}
    {% set eta_epoch = f.get('time_estimated_arrival', 0) | int %}
    {% set departure_epoch = f.get('time_real_departure', 0) | int %}
    {% set now_epoch = as_timestamp(now()) | int %}
    {% set progress_pct = 100 * (now_epoch - departure_epoch) / (eta_epoch - departure_epoch) if (eta_epoch - departure_epoch) > 0 else 0 %}

    {# --- Header text --- #}
    {% if mode == 'local' %}
      {% set header   = 'Closest flight • ' ~ dist ~ ' ' ~ distance_unit ~ ' from home' %}
      {% set sublabel = 'Nearby flight' %}
    {% else %}
      {% set header   = 'Most tracked flight on Flightradar24' %}
      {% set sublabel = 'Most tracked flight' %}
    {% endif %}

    {# --- Label under logo (with private/unknown handling) --- #}
    {% if fn.startswith('N') or cs.startswith('N') %}
      {% set airline_label = 'Private aircraft' %}
    {% else %}
      {% if 'unknown' in airline_l %}
        {% set airline_label = icao if icao else sublabel %}
      {% else %}
        {% set airline_label = airline %}
      {% endif %}
    {% endif %}

    <div style="
      display:flex;
      flex-direction:column;
      width:100%;
      padding:8px;
      max-width:1000px;
    ">

      <div style="
        width:100%;
        display:grid;
        grid-template-columns:1fr auto;
        gap:16px;
        align-items:center;
      ">

        <div style="display:flex;flex-direction:column;gap:6px;">
          <div style="
            font-size:11px;
            opacity:0.7;
            letter-spacing:0.15em;
            text-transform:uppercase;
          ">
            {{ header }}
          </div>

          <div style="
            font-size:26px;
            font-weight:600;
          ">
            {{ fn if fn|length > 0 else cs }}
          </div>

          <div style="
            font-size:15px;
            opacity:0.8;
            display:flex;
            flex-direction:row;
            white-space:nowrap;
            min-width:0;
            gap:5px;
            width:85%;
          ">
            <span style="flex-shrink: 0; max-width: 70%;">
              {{ airline_label }} 
            </span>
          
            <span style="
              flex-shrink:1;
              overflow-x:hidden;
              text-overflow:ellipsis;
            ">({{ cs }})
            </span>
          </div>

          <div style="
            font-size:17px;
            opacity:0.9;
            margin-top:2px;
          ">
            {{ origin }} → {{ dest }}
          </div>

          <div style="
            margin-top:8px;
            font-size:13px;
            display:flex;
            gap:24px;
            flex-wrap:wrap;
          ">

            <div>
              <div style="
                font-size:10px;
                opacity:0.6;
                text-transform:uppercase;
                letter-spacing:0.15em;
              ">
                Altitude
              </div>
              <div style="font-size:20px;font-weight:600;">
                {{ alt|int }} ft
              </div>
            </div>

            <div>
              <div style="
                font-size:10px;
                opacity:0.6;
                text-transform:uppercase;
                letter-spacing:0.15em;
              ">
                Ground Speed
              </div>
              <div style="font-size:20px;font-weight:600;">
                {{ gs|int }} kts
              </div>
            </div>

            <div>
              <div style="
                font-size:10px;
                opacity:0.6;
                text-transform:uppercase;
                letter-spacing:0.15em;
              ">
                Aircraft
              </div>
              <div style="font-size:20px;font-weight:600;">
                {{ aircraft }}
              </div>
            </div>

          </div>

          {# Adapted from https://github.com/plckr/flightradar-flight-card/blob/main/src/flight-progress-bar.ts #}
          <div style="
            margin-top:8px;
            font-size:13px;
            display:flex;
            gap:2px;
            flex-wrap:wrap;
          ">
              <div style="
                width:100%;
                position: relative;
                background: var(--state-active-color);
                background: linear-gradient(
                  90deg,
                  var(--state-active-color) 0%,
                  var(--state-active-color) calc({{ progress_pct }} * 1%),
                  var(--secondary-background-color) calc({{ progress_pct }} * 1%),
                  var(--secondary-background-color) 100%
                );
                height: 4px;
                border-radius: 999px;
              ">
                <ha-icon style="
                  position: absolute;
                  top: 0px;
                  left: calc({{ progress_pct }} * 1%);
                  transform: translate(-50%, -50%);
                  --mdc-icon-size: var(--ha-space-4);
                  background: var(--card-background-color, #fff);
                  color: var(--accent-color)" icon="mdi:airplane" />
              </div>

              {% if eta_epoch and eta_epoch > now_epoch %}
                {% set remaining = eta_epoch - now_epoch %}
                <div style="
                  width:100%;
                  font-size:12px;
                  opacity:0.6;
                  text-align: right;
                ">
                {% if remaining > 3600 %}
                  {{ (remaining / 3600) | round(0) }}h{{ (remaining / 60) | round(0) % 60 }}m remaining
                {% elif remaining > 60 %}
                  {{ (remaining / 60) | round(0) }}m remaining
                {% else %}
                  {{ remaining }}s remaining
                {% endif %}
                </div>
              {% endif %}
          </div>
        </div>

      </div>
    </div>

  {% endif %} </div>
